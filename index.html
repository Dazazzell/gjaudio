<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MP3 Voting Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    canvas { max-width: 600px; }
  </style>
</head>
<body>
  <h1>Voting Results</h1>
  <canvas id="voteChart"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // âœ… Replace with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDp_cESC1PrXHxnTC2JMRdR928KXXwEvOw",
      authDomain: "gjaudio-d18d9.firebaseapp.com",
      projectId: "gjaudio-d18d9",
      storageBucket: "gjaudio-d18d9.firebasestorage.app",
      messagingSenderId: "740115381859",
      appId: "1:740115381859:web:a19505a463269198274256"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Tracks (hardcoded or fetched elsewhere)
    const tracks = [
      { id: 'track1', title: 'Track One' },
      { id: 'track2', title: 'Track Two' }
    ];

    const voteCounts = {}; // trackId -> { total: sum, count: numVotes }

    // Initialize empty counts
    tracks.forEach(track => voteCounts[track.id] = { total: 0, count: 0 });

    // Fetch and process votes
    async function loadVotes() {
      const snapshot = await getDocs(collection(db, "votes"));

      snapshot.forEach(doc => {
        const data = doc.data();
        if (voteCounts[data.trackId]) {
          voteCounts[data.trackId].total += data.score;
          voteCounts[data.trackId].count += 1;
        }
      });

      drawChart();
    }

    function drawChart() {
      const labels = tracks.map(t => t.title);
      const averages = tracks.map(t => {
        const { total, count } = voteCounts[t.id];
        return count > 0 ? (total / count).toFixed(2) : 0;
      });

      new Chart(document.getElementById("voteChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Average Score",
            data: averages,
            backgroundColor: "#4e79a7"
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 10
            }
          }
        }
      });
    }

    loadVotes();
  </script>
</body>
</html>
